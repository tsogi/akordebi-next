version: '3.8'

services:
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    image: akordebi-nginx:latest
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Only dynamic data needs to be mounted as volumes
      - letsencrypt:/etc/letsencrypt:ro  # SSL certificates (generated by certbot, expire and renew)
      - certbot-www:/var/www/certbot:ro  # ACME challenge files (temporary, generated by certbot)
    depends_on:
      - akordebi
      # - tsogi_manager
    networks:
      - app-network

  certbot:
    image: certbot/certbot
    volumes:
      - certbot-www:/var/www/certbot
      - letsencrypt:/etc/letsencrypt
    networks:
      - app-network

  akordebi:
    image: akordebi:1.4
    restart: unless-stopped
    environment:
      - PORT=3002
    depends_on:
      - mysql
    networks:
      - app-network
    # Don't expose ports directly - nginx will proxy

  # tsogi_manager:
  #   image: tsogi_manager:1.0
  #   restart: unless-stopped
  #   environment:
  #     - PORT=3003
    # networks:
      # - app-network
    # Don't expose ports directly - nginx will proxy

  mysql:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-nikoloz93}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-akordebi.ge}
      - MYSQL_USER=${MYSQL_USER:-root}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-nikoloz93}
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - app-network

volumes:
  letsencrypt:      # SSL certificates - MUST be volume (dynamic, expires, unique per domain)
  certbot-www:      # ACME challenge files - MUST be volume (temporary, generated on-demand)
  mysql-data:       # Database files - MUST be volume (persistent data)

networks:
  app-network:
    driver: bridge

